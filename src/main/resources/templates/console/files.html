<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <link rel="stylesheet" href="/static/bootstrap-4.6.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/fontawesome/all.min.css">
    <link rel="stylesheet" href="/static/css/dashbroad.css">
</head>
<body>

<nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="#">Company name</a>
    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-toggle="collapse" data-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search">
    <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
            <a class="nav-link" href="#">登出</a>
        </li>
    </ul>
</nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a href="/console/articles" class="nav-link">
                            <i class="fas fa-home"></i>
                            文章管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/console/moments" class="nav-link">
                            <i class="fas fa-magic"></i>
                            动态管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/console/files" class="nav-link active">
                            <i class="fas fa-file-archive"></i>
                            文件管理
                        </a>
                    </li>
                </ul>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 border-bottom">
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <input type="text" class="form-control" id="queryInput">
                        <button type="button" id="show-upload-modal-btn" class="btn btn-primary">查询</button>
                        <a class="btn btn-warning" href="/console/article/create">新增</a>
                    </div>
                </div>


                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>文件名称</th>
                                <th>文件类型</th>
                                <th>扩展名</th>
                                <th>大小</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="filePanel">

                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <!-- uploadModel -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">上传文件</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="path" class="col-form-label">Bucket:</label>
                        <select id="path" class="custom-select">
                            <option id="">请选择 Bucket</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="file" class="col-form-label">File:</label>
                        <input type="file" class="form-control-file" multiple name="file" id="file">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" id="file-upload-btn" class="btn btn-primary">上传</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/bootstrap-4.6.2-dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/fontawesome/all.min.js"></script>
    <script>
        $('#show-upload-modal-btn').click(function() {
            $('#uploadModal').modal('show')
        })
        $("#file-upload-btn").click(function() {
            let formData = new FormData()
            let path = $('#path').val()
            // if(path === "" || path.length === 0) {
            //     alert('请选择存储 Bucket');
            //     return;
            // }
            let file = document.getElementById('file').files[0];
            if(file === null) {
                alert('请选择文件')
                return;
            }
            // formData.append('path', path)
            formData.append("files", file)

            $.ajax({
                url: '/api/file/upload',
                method: 'POST',
                cache: false,
                processData: false,
                contentType: false,
                data: formData,
                xhr:function(){
                    let myXhr = $.ajaxSettings.xhr();
                    if(myXhr.upload){ // check if upload property exists
                        myXhr.upload.addEventListener('progress',function(e){
                            // var loaded = e.loaded;//已经上传大小情况
                            // var tot = e.total;//附件总大小
                            // var per = Math.floor(100*loaded/tot).toFixed(2);
                            // $("#progress").text( per +"%" );//设置进度显示百分比
                            // $("#progress").css("width" , per +"%"); //设置完成的进度条宽度

                        }, false); // for handling the progress of the upload
                    }
                    return myXhr;
                },
                success:function(data){
                    console.log(data);
                    // console.log("上传成功!!!!");
                    $('#uploadModal').modal('hide')
                },
                error:function(xhrRequest, error, thrown){
                    console.log("上传失败！");
                }
            })

        })


        $(document).ready(function() {
            getFileInfos()
        })


        function getFileInfos() {
            $.ajax({
                url: '/api/files?page=1&size=10',
                method: 'GET',
                dataType: 'json',
                contentType: 'application/json;charset=utf8',
                success: function(res) {
                    let html = "";
                    for(let i = 0; i < res.length; i++) {
                        html += '<tr>'
                        if(res[i].fileType === 'DIR') {
                            html += '<td><img src="/static/icon/folder.png" style="width: 32px !important;" /> <a href="javascript:void(0);">'+res[i].filename+'</a></td>'
                        } else {
                            html += '<td><img src="/static/icon/file.png" style="width: 32px !important;" /><a href="javascript:void(0);">'+res[i].filename+'</a></td>'
                        }
                        if(res[i].fileType === 'DIR') {
                            html += '<td>文件夹</td>'
                        } else {
                            html += '<td>文件</td>'
                        }
                        if(res[i].fileType === 'DIR') {
                            html += '<td></td>'
                        } else {
                            html += '<td>'+res[i].fileExtension+'</td>'
                        }
                        if(res[i].fileType === 'DIR') {
                            html += '<td>-</td>'
                        } else {
                            html += '<td>'+res[i].fileSize+'</td>'
                        }
                        html += '<td>2023-2-21 11:08:06</td>'
                        html += '<td>'
                        if(res[i].editable === true){
                            html += '<a href="/console/file/edit?path='+res[i].path+'">编辑</a>'
                        }
                        html += '</td>'
                        html += '</tr>'
                    }
                    $('#filePanel').html(html)

                },
                error: function(xhrRequest, error, thrown) {

                }
            })
        }

    </script>


<script>



</script>
</body>
</html>